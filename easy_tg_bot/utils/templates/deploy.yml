name: Deploy to Vultr

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      run: |
        echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login "https://sjc.vultrcr.com/${{ secrets.CONTAINER_REGISTRY_NAME }}" -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin

    - name: Build and push Docker image
      run: |
        docker build -t ${{ secrets.APP_NAME }}:${{ secrets.IMAGE_TAG }} . --no-cache
        docker tag ${{ secrets.APP_NAME }}:${{ secrets.IMAGE_TAG }} sjc.vultrcr.com/${{ secrets.CONTAINER_REGISTRY_NAME }}/${{ secrets.APP_NAME }}:${{ secrets.IMAGE_TAG }}
        docker push sjc.vultrcr.com/${{ secrets.CONTAINER_REGISTRY_NAME }}/${{ secrets.APP_NAME }}:${{ secrets.IMAGE_TAG }}

    - name: Deploy to Vultr
      run: |
        echo "${{ secrets.VULTR_SERVER_SSH_KEY }}" > /tmp/vultr_key
        
        # Ensure the key has the correct permissions
        chmod 600 /tmp/vultr_key
        
        # Connect to the server
        ssh -o StrictHostKeyChecking=no -i /tmp/vultr_key ${{ secrets.VULTR_SERVER_USER }}@${{ secrets.VULTR_SERVER_IP }} << 'EOF'

          # Volumes configuration
          mkdir -p ${{ secrets.TG_BOT_NAME }}
          mkdir -p ${{ secrets.TG_BOT_NAME }}/${{ secrets.TG_FILE_FOLDER_PATH }}
          
          # Clear previous containers
          docker stop ${{ secrets.APP_NAME }} || true
   
          # Run the container
          echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login https://sjc.vultrcr.com/${{ secrets.CONTAINER_REGISTRY_NAME }} -u ${{ secrets.DOCKER_HUB_USERNAME }} --password-stdin
          
          docker pull sjc.vultrcr.com/${{ secrets.CONTAINER_REGISTRY_NAME }}/${{ secrets.APP_NAME }}:${{ secrets.IMAGE_TAG }}
          
          docker run -d --name ${{ secrets.APP_NAME }} \
          -v /${{ secrets.VULTR_SERVER_USER }}/${{ secrets.TG_BOT_NAME }}/${{ secrets.TG_FILE_FOLDER_PATH }}:/usr/src/app/${{ secrets.TG_FILE_FOLDER_PATH }} \
          -e TG_BOT_NAME=${{ secrets.TG_BOT_NAME }} \
          -e TG_BOT_TOKEN=${{ secrets.TG_BOT_TOKEN }} \
          -e TG_MY_ID=${{ secrets.TG_MY_ID }} \
          -e TG_FILE_FOLDER_PATH=${{ secrets.TG_FILE_FOLDER_PATH }} \
          sjc.vultrcr.com/${{ secrets.CONTAINER_REGISTRY_NAME }}/${{ secrets.APP_NAME }}:${{ secrets.IMAGE_TAG }}

          # Clear unused
          docker system prune -af 
        EOF

    - name: Clean up temporary files
      run: |
        rm -f /tmp/vultr_key
